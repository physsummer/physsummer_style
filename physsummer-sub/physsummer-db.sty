\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{physsummer-db}

\RequirePackage{import}
\RequirePackage{xspace}
\RequirePackage{xargs}
\RequirePackage{xparse}

\newcommand{\libproblemgroup}{}
\newcommand{\libproblemid}{}
\newcommand{\libexperimentgroup}{}
\newcommand{\libexperimentid}{}


\newcommand{\setcurrentproblem}[2]{
    \renewcommand{\libproblemgroup}{#1}
    \renewcommand{\libproblemid}{#2}
}

\newcommand{\setcurrentexperiment}[2]{
    \renewcommand{\libexperimentgroup}{#1}
    \renewcommand{\libexperimentid}{#2}
}

% где всё лежит
\newcommand{\libproblempath}{problems_db}
% если этот перебор не работает, делай \renewcommand{\libproblempath}{правильный-путь}
\IfFileExists{../problems_db/db.stamp}
  {\renewcommand{\libproblempath}{../problems_db}}
  {\IfFileExists{../../problems_db/db.stamp}
    {\renewcommand{\libproblempath}{../../problems_db}}
    {\IfFileExists{../../../problems_db/db.stamp}
      {\renewcommand{\libproblempath}{../../../problems_db}}
      {\IfFileExists{../../../../problems_db/db.stamp}
        {\renewcommand{\libproblempath}{../../../../problems_db}}
        {\IfFileExists{../../../../../problems_db/db.stamp}
          {\renewcommand{\libproblempath}{../../../../../problems_db}}
          {}
        }
      }
    }
  }


\newcommand{\libexperimentpath}{experiments_db}
% если этот перебор не работает, делай \renewcommand{\libexperimentpath}{правильный-путь}
\IfFileExists{../experiments_db/db.exp.stamp}
  {\renewcommand{\libexperimentpath}{../experiments_db}}
  {\IfFileExists{../../experiments_db/db.exp.stamp}
    {\renewcommand{\libexperimentpath}{../../experiments_db}}
    {\IfFileExists{../../../experiments_db/db.exp.stamp}
      {\renewcommand{\libexperimentpath}{../../../experiments_db}}
      {\IfFileExists{../../../../experiments_db/db.exp.stamp}
        {\renewcommand{\libexperimentpath}{../../../../experiments_db}}
        {\IfFileExists{../../../../../experiments_db/db.exp.stamp}
          {\renewcommand{\libexperimentpath}{../../../../../experiments_db}}
          {}
        }
      }
    }
  }
  
\newtoggle{unnumberedpic}


% извлечение текста задачи
% по умолчанию извлекается из текущей, иначе надо вызывать в формате:
% \libproblemtext[region][2013-10-2]
\newcommandx{\libproblemtext}[2][1=\libproblemgroup,2=\libproblemid]{
    \ifteacher{\texttt{[\libproblemgroup/\libproblemid]\,}}\fi%
    \subimport{\libproblempath/#1/}{#2}
}


% извлечение рисунка задачи
% по умолчанию извлекается из текущей, иначе надо вызывать в формате:
% \libproblemfig[region][2013-10-2]
% сюда можно добавить параметр на случай, если рисунков несколько
\newcommandx{\libproblemfig}[2][1=\libproblemgroup, 2=\libproblemid]{
    \subimport{\libproblempath/#1/}{#2-fig}
}



% вставка отформатированной задачи
\newcommand{\libproblem}[3][default]{
    \setcurrentproblem{#2}{#3}
    \IfFileExists{\libproblempath/#2/#3-#1}{
        % видимо баг в subimport и это сейчас не работает, замените у себя на input (следующая строка), если это так. Ждем,
        % когда пофиксят, если пофиксят.
        \subimport{\libproblempath/#2/}{#3-#1}
        %\input{\libproblempath/#2/#3-#1}
    }{ % file doesn't exist
        \IfFileExists{\libproblempath/#2/#3-fig} { % default behavior, figure present
            \libproblemtaskpic
        } { % default behavior, no figure
            \libproblemtask
        }
    }
}


\newcommandx{\libexperimenttext}[2][1 = \libexperimentgroup, 2 = \libexperimentid]{
    \ifteacher{\texttt{[\libexperimentgroup/\libexperimentid]}}\fi
    \subimport{\libexperimentpath/#1/}{#2}
}


\newcommandx{\libexperimentcriteria}[2][1 = \libexperimentgroup, 2 = \libexperimentid]{
    \criteriainit{
        \subimport{\libexperimentpath/#1/}{#2-crit}
    }
}

\ExplSyntaxOn
\NewDocumentCommand{\libexperiment}{o O{default}mm}{
    \setcurrentexperiment{#3}{#4}
    \IfFileExists{\libexperimentpath/#3/#4-#2} {
        \subimport{\libexperimentpath/#3/}{#4-#2}
    }{ % file doesn't exist
        \exptask{
            \libexperimenttext
                        
        }\par

        \IfNoValueTF{#1}{
            \vspace{0.1cm}
            \IfFileExists{\libexperimentpath/#3/#4-crit}{
                \libexperimentcriteria
            }{
                \message{Cannot find criteria file:\libexperimentpath/#3/#4-crit}
            }
        }{
            #1
        }
    }
}

\ExplSyntaxOff

\newcommandx{\libproblemtask}{
    \toggletrue{unnumberedpic}
    \task{
        \libproblemtext
    }
    \togglefalse{unnumberedpic}
}

\newcommand{\libproblemtaskpic}[1][4cm]{
    \toggletrue{unnumberedpic}
    \taskpic[#1]{
        \libproblemtext
    }{
        \libproblemfig
    }
    \togglefalse{unnumberedpic}
}

\newcommand{\libproblemtaskfigbelow}{
    \toggletrue{unnumberedpic}
    \libproblemtask
    \begin{center}
        \libproblemfig
    \end{center}
    \togglefalse{unnumberedpic}
}

\newcommand{\libproblemtaskdoublepic}{
    \toggletrue{unnumberedpic}
    \libproblemtaskpic
    \begin{center}
        \subimport{\libproblempath/\libproblemgroup/}{\libproblemid-fig2}
    \end{center}
    \toggletrue{unnumberedpic}
}

\newcommand{\figrefname}[1]{\libproblemgroup:\libproblemid:#1}

\newcommand{\libproblemtasktwobelow}{
    \toggletrue{unnumberedpic}
    \libproblemtask
    \togglefalse{unnumberedpic}
    \drawsidebyside{\figrefname{1}}{
        \libproblemfig
    }{\figrefname{2}}{
        \subimport{\libproblempath/\libproblemgroup/}{\libproblemid-fig2}
    }
}

% ссылка на рисунок
\newcommand{\ifnumbered}[2]{%
    \iftoggle{unnumberedpic}{#2}{#1~\ref{fig:\figrefname{}}}\xspace%
}

% обычная ссылка на рисунок
%\newcommand{\seefig}{(\ifnumbered{рис.}{см. рис.}\xspace)}
\newcommand{\seefig}{(\ifnumbered{рис.}{см. рис.})}


\newcommand{\seefigref}{\ifnumbered{рис.}{см. рис.}}
\newcommand{\figref}{\ifnumbered{}{}}

\endinput
